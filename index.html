<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GLOBAL CASH TIME | Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCntjKiPwfoCq0MzHIkybX4VZuYE_ZCnOE",
            authDomain: "globalcash-6fbe8.firebaseapp.com",
            databaseURL: "https://globalcash-6fbe8-default-rtdb.firebaseio.com",
            projectId: "globalcash-6fbe8",
            storageBucket: "globalcash-6fbe8.firebasestorage.app",
            messagingSenderId: "476476155798",
            appId: "1:476476155798:web:947a0e0140acfca78d5fb7",
            measurementId: "G-4L6LQ3ZL7S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbUpdate = update;
    </script>

    <style>
        :root { --primary: #ffea00; --primary-dark: #ccac00; --bg: #050505; --card: #121212; --text: #ffffff; --green: #00ff66; --red: #ff0000; --link: #88ccff; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; position: relative; min-height: 100vh; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, #1a1500 0%, #050505 100%); z-index: -2; }
        .bg-glow { position: fixed; width: 100vw; height: 100vh; z-index: -1; top: 0; left: 0; pointer-events: none; }
        .particle { position: absolute; width: 2px; height: 15px; background: var(--primary); opacity: 0.2; animation: rain linear infinite; }
        @keyframes rain { 0% { transform: translateY(-100px); } 100% { transform: translateY(110vh); } }
        header { width: 100%; padding: 20px 0; background: rgba(18, 18, 18, 0.9); border-bottom: 2px solid var(--primary); text-align: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .main-container { width: 95%; max-width: 1200px; padding: 10px; box-sizing: border-box; flex-grow: 1; }
        button { background: linear-gradient(145deg, #fff200, #b8860b); color: #000; border: 1px solid #fff; padding: 12px; font-weight: 900; cursor: pointer; border-radius: 8px; font-size: 12px; text-transform: uppercase; transition: 0.3s; box-shadow: 0 0 10px rgba(255, 234, 0, 0.2); }
        .profile-card { display: none; background: linear-gradient(145deg, #1a1a1a, #0a0800); border: 2px solid var(--primary); padding: 15px; border-radius: 15px; margin: 0 auto 20px; width: 100%; max-width: 480px; box-sizing: border-box; }
        .label-gold { color: var(--primary); font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .section-box { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; border: 1px solid #222; }
        
        .info-promo-box { background: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center; }
        .promo-title { color: var(--green); font-weight: 900; font-size: 18px; margin-bottom: 5px; }
        .promo-subtitle { font-size: 13px; color: #ccc; margin-bottom: 10px; }
        .promo-giros { display: flex; justify-content: center; gap: 10px; font-size: 12px; font-weight: bold; }
        .giro-tag { background: #222; padding: 5px 10px; border-radius: 5px; border: 1px solid var(--primary-dark); }

        /* MANTENIENDO EXACTAMENTE LA CONSISTENCIA DE 5 COLUMNAS */
        .salas-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .sala-card { background: #0a0a0a; border: 1px solid #333; border-radius: 12px; padding: 8px; text-align: center; cursor: pointer; transition: 0.3s; }
        .sala-card.active { border-color: var(--primary); background: #2a2200; box-shadow: 0 0 15px rgba(255, 234, 0, 0.4); }

        .game-layout { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start; }
        .left-col { width: 320px; flex-shrink: 0; }
        .right-col { flex: 1; min-width: 300px; }
        #canvas-container { position: relative; margin: 0 auto; width: 300px; height: 300px; }
        #pointer { position: absolute; right: -5px; top: 50%; transform: translateY(-50%); width: 30px; height: 20px; background: #fff; clip-path: polygon(100% 0%, 0% 50%, 100% 100%); z-index: 10; transition: transform 0.1s ease-out; transform-origin: center right; }
        canvas { width: 300px !important; height: 300px !important; border-radius: 50%; border: 4px solid #222; }
        .numbers-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; background: #000; padding: 10px; border-radius: 8px; max-height: 400px; overflow-y: auto; }
        .num-btn { padding: 8px 0; font-size: 10px; border: 1px solid #333; background: #111; color: #fff; cursor: pointer; border-radius: 4px; }
        .num-btn.selected { background: var(--green); color: #000; font-weight: bold; }
        .num-btn.taken { background: #ff0000 !important; color: #fff !important; cursor: not-allowed; pointer-events: none; opacity: 1; font-weight: bold; }
        .btn-rand { background: #222; color: #fff; border: 1px solid #444; padding: 8px; font-size: 10px; flex: 1; text-transform: none; }
        .btn-rand b { color: var(--primary); display: block; font-size: 11px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; }
        input, select { width: 90%; padding: 14px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; text-align: center; }
        .password-wrapper { position: relative; width: 90%; margin: 0 auto; }
        .eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; }
        .auth-links { margin-top: 15px; font-size: 12px; color: var(--link); cursor: pointer; text-decoration: underline; }
        .wallet-box { background: #111; border: 1px dashed var(--primary); padding: 10px; border-radius: 8px; font-size: 11px; word-break: break-all; margin: 10px 0; cursor: pointer; }
        .upload-box { border: 2px dashed #444; padding: 10px; margin: 10px 0; border-radius: 8px; cursor: pointer; background: #0a0a0a; font-size: 11px; }
        #preview-img { width: 100%; max-height: 100px; object-fit: contain; margin-top: 10px; display: none; }
        .admin-notif { background: #1a1a1a; padding: 10px; margin-bottom: 10px; border-radius: 5px; font-size: 11px; border-left: 3px solid var(--primary); text-align: left; }
        footer { width: 100%; padding: 30px 0; background: #0a0a0a; border-top: 1px solid #222; text-align: center; color: #555; font-size: 12px; }
        .f-links { margin-top: 10px; display: flex; justify-content: center; gap: 15px; color: var(--link); cursor: pointer; }
        @media (max-width: 768px) { .salas-grid { grid-template-columns: repeat(2, 1fr); } .left-col, .right-col { width: 100%; } }
    </style>
</head>
<body>

<div class="bg-glow" id="rain-container"></div>

<header>
    <div style="font-weight: 900; font-size: 26px; color: var(--primary);">üî±GLOBAL CASH TIMEüî±</div>
    <div id="guest-btn" style="margin-top:10px;"><button onclick="openM('auth')" style="width:auto; padding:8px 30px;">LOGIN / REGISTRO</button></div>
</header>

<div class="main-container">
    <div id="user-profile" class="profile-card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><span class="label-gold">CUENTA</span><div id="prof-name" style="font-weight:900;">---</div></div>
            <div style="text-align:right;"><span class="label-gold">SALDO</span><div id="prof-balance" style="color:var(--green); font-weight:900; font-size:24px;">$0.00</div></div>
        </div>
        <div style="display:flex; gap:5px; margin-top:15px;">
            <button onclick="openM('dep')" style="flex:1;">DEPOSITAR</button>
            <button onclick="openM('with')" style="flex:1; background:var(--red); color:#fff;">RETIRAR</button>
            <button onclick="openM('hist')" style="flex:1; background:#444; color:#fff;">HISTORIAL</button>
            <button onclick="logout()" style="flex:1; background:#333; color:#fff;">SALIR</button>
        </div>
        <div id="admin-panel" style="display:none; margin-top:15px; border-top:1px solid #444; padding-top:10px;">
            <span class="label-gold">PANEL ADMIN (RECARGAS / RETIROS / USUARIOS)</span>
            <div id="admin-actions" style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <button onclick="renderAdmin()" style="font-size:9px;">NOTIFICACIONES</button>
                <button onclick="renderUserDB()" style="font-size:9px;">BASE DE DATOS</button>
                <button onclick="renderPassReqs()" style="font-size:9px;">CLAVES</button>
                <button onclick="resetSalasManual()" style="font-size:9px; background:red; color:white;">RESET TODAS SALAS</button>
            </div>
            <div id="pending-deps" style="margin-top:10px; max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <div class="info-promo-box">
        <div class="promo-title">GANA $50 CON $0,50</div>
        <div class="promo-subtitle">3 ENTRE 200 | ¬°Bienvenido! al Sorteo por Participaci√≥n</div>
        <div class="promo-giros">
            <div class="giro-tag">GIRO 1: $5</div>
            <div class="giro-tag">GIRO 2: $10</div>
            <div class="giro-tag">GIRO 3: $50 üèÜ</div>
        </div>
        <div style="font-size: 10px; margin-top: 10px; color: var(--primary); font-weight: bold;">¬°QUE GANE EL MEJOR!</div>
    </div>

    <div class="salas-grid" id="grid-salas"></div>

    <div class="section-box game-layout">
        <div class="left-col">
            <h3 id="sala-txt" style="color:var(--primary); margin:0;">SALA #1</h3>
            <div id="canvas-container"><div id="pointer"></div><canvas id="wheel" width="600" height="600"></canvas></div>
            <p id="prog-txt" style="font-weight:bold; margin:10px 0 5px;">0 / 200 Vendidos</p>
            <div id="live-counter" style="color:var(--green); font-size: 18px; font-weight: 900; height: 25px;"></div>
            <p id="status-txt" style="color:var(--primary); font-weight:bold; min-height:1.2em; margin-top: 5px;"></p>
            
            <table style="width:100%; background:#000; border:1px solid var(--primary-dark); font-size:11px; margin-top:10px;">
                <tr><th style="background:var(--primary); color:#000;">GIRO</th><th style="background:var(--primary); color:#000;">PREMIO</th></tr>
                <tr><td>1er Giro</td><td>$5.00 USD</td></tr>
                <tr><td>2do Giro</td><td>$15.00 USD</td></tr>
                <tr><td>3er Giro</td><td>$50.00 USD</td></tr>
            </table>

            <button id="buy-btn" onclick="comprarSeleccion()" style="width:100%; height:50px; margin:10px 0; font-size:14px;">COMPRAR SELECCIONADOS</button>
            <div style="display:flex; gap:5px;">
                <button class="btn-rand" onclick="rand(5)"><b>5 Aleatorios</b>$2.50</button>
                <button class="btn-rand" onclick="rand(15)"><b>15 Aleatorios</b>$7.50</button>
                <button class="btn-rand" onclick="rand(25)"><b>25 Aleatorios</b>$12.50</button>
            </div>
        </div>
        <div class="right-col">
            <h4 style="margin:0 0 10px 0; color:var(--primary);">SELECCI√ìN MANUAL ($0.50)</h4>
            <div class="numbers-grid" id="num-selector"></div>
        </div>
    </div>
</div>

<footer>
    <div style="color:var(--primary); font-weight: 900; margin-bottom: 5px;">GLOBAL CASH TIME ¬© 2026</div>
    <div>Soporte: globalcashtime@gmail.com</div>
    <div class="f-links">
        <span onclick="openM('faq')">Preguntas Frecuentes</span>
        <span onclick="openM('nosotros')">Nosotros</span>
        <span onclick="openM('contacto')">Contacto</span>
    </div>
</footer>

<div id="modal" class="modal"><div id="modal-content" class="section-box" style="width:90%; max-width:380px;"></div></div>

<script>
let users = [], currentU = null, ang = 0, sSel = 0, mySelection = [], tempImg = "";
let pendingDeps = [], pendingWiths = [], passReqs = [], historial = []; 
// IMPLEMENTACI√ìN DE 50 SALAS
let salas = Array.from({length: 50}, (_, i) => ({ 
    id: i+1, count: 0, sold: [], isSpinning: false, isWaiting: false, waitStep: 0, currentGiro: 0, endTime: 0, lastWinner: null 
}));

const wheelNumbers = Array.from({length: 200}, (_, i) => i + 1).sort(() => Math.random() - 0.5); 
const PREMIOS = { 1: 5, 2: 15, 3: 50 };

window.onload = () => {
    createRain();
    const checkFirebase = setInterval(() => {
        if(window.db) {
            clearInterval(checkFirebase);
            initApp();
        }
    }, 100);
};

function initApp() {
    window.dbOnValue(window.dbRef(window.db), (snapshot) => {
        const data = snapshot.val() || {};
        users = data.users || [];
        pendingDeps = data.pendingDeps || [];
        pendingWiths = data.pendingWiths || [];
        passReqs = data.passReqs || [];
        historial = data.historial || [];
        
        let dbSalas = data.salas || [];
        if(dbSalas.length > 0) salas = dbSalas;
        if(salas.length < 50) {
            for(let i=salas.length; i<50; i++) salas.push({id: i+1, count: 0, sold: [], isSpinning: false, isWaiting: false, waitStep: 0, currentGiro: 0, endTime: 0, lastWinner: null});
        }

        let resetRequired = false;
        salas.forEach(s => {
            if(s.currentGiro >= 3 && !s.isSpinning && !s.isWaiting && s.count > 0) {
                s.currentGiro = 0; s.count = 0; s.sold = []; s.lastWinner = null;
                resetRequired = true;
            }
        });
        if(resetRequired) save();

        const saved = localStorage.getItem('GCT_SESSION');
        if(saved) {
            if(saved === "ADMIN_GLOBAL") { 
                currentU = {u:"ADMIN_GLOBAL", b:0}; 
                document.getElementById('admin-panel').style.display='block';
            } else { 
                let found = users.find(x => x.u === saved);
                if(found) {
                    currentU = found;
                    document.getElementById('prof-balance').innerText = `$${currentU.b.toFixed(2)}`;
                }
            }
            if(currentU) showProfile();
        }
        
        sSel = parseInt(localStorage.getItem('GCT_S_SEL')) || 0;
        renderGrid();
        renderNumbers();
        document.getElementById('sala-txt').innerText = `SALA #${salas[sSel]?.id || (sSel+1)}`;
        updateUI();
    });
    setInterval(logic, 30);
    draw();
}

function save() { window.dbSet(window.dbRef(window.db), { users, pendingDeps, pendingWiths, passReqs, historial, salas }); }
function createRain() { const container = document.getElementById('rain-container'); for(let i=0; i<60; i++) { let p = document.createElement('div'); p.className = 'particle'; p.style.left = Math.random() * 100 + 'vw'; p.style.animationDuration = (Math.random() * 3 + 2) + 's'; p.style.animationDelay = Math.random() * 5 + 's'; container.appendChild(p); } }
function getWinningNumber() { const normalizedAng = (ang % (Math.PI * 2) + (Math.PI * 2)) % (Math.PI * 2); const index = Math.floor(((Math.PI * 2 - normalizedAng) / (Math.PI * 2)) * 200) % 200; return wheelNumbers[index]; }

function logic() {
    const now = Date.now(); let change = false;
    salas.forEach((s, i) => {
        if(s.isSpinning) {
            let timeLeft = s.endTime - now; let duration = 60000; let progress = Math.min(1, (duration - timeLeft) / duration); let speed = 0.5 * Math.pow(1 - progress, 2.5); 
            if(timeLeft <= 0 || speed <= 0.0001) {
                const finalWinner = getWinningNumber(); s.isSpinning = false; s.isWaiting = true; s.waitStep = 1; s.endTime = now + 2000; s.lastWinner = finalWinner;
                let winnerData = (s.sold || []).find(x => x.n === s.lastWinner); let premioMonto = PREMIOS[s.currentGiro];
                if(winnerData) { let winUser = users.find(u => u.u === winnerData.u); if(winUser) { winUser.b += premioMonto; } }
                historial.push({ type:'win', u: winnerData ? winnerData.u : 'Nadie', sala: s.id, ganador: s.lastWinner, premio: premioMonto, fecha: new Date().toLocaleString() });
                if(i === sSel) { document.getElementById('live-counter').innerText = ""; document.getElementById('pointer').style.transform = `translateY(-50%) rotate(0deg)`; }
                change = true;
            } else if(i === sSel) {
                ang += speed; const ptr = document.getElementById('pointer');
                if (speed > 0.001) { let hitFrequency = Math.sin(ang * 200); ptr.style.transform = `translateY(-50%) rotate(${hitFrequency * 8 * (1-progress)}deg)`; document.getElementById('live-counter').innerText = `SORTEANDO: ${getWinningNumber()}`; }
                else { ptr.style.transform = `translateY(-50%) rotate(0deg)`; document.getElementById('live-counter').innerText = ""; }
                draw(); 
            }
        } else if(s.isWaiting) {
            if(s.waitStep === 1 && now >= s.endTime) { s.waitStep = 2; s.endTime = now + 4000; change = true; } 
            else if(s.waitStep === 2) {
                if(i === sSel && s.lastWinner) document.getElementById('live-counter').innerText = `GANADOR: #${s.lastWinner}`;
                if(now >= s.endTime) {
                    s.waitStep = 0;
                    if (s.currentGiro < 3) { s.currentGiro++; s.isSpinning = true; s.isWaiting = false; s.endTime = now + 60000; } 
                    else { s.currentGiro = 0; s.count = 0; s.sold = []; s.lastWinner = null; s.isWaiting = false; s.isSpinning = false; if(i === sSel) { document.getElementById('live-counter').innerText = ""; document.getElementById('status-txt').innerText = ""; renderNumbers(); renderGrid(); } }
                    change = true;
                }
            }
        }
    });
    if(change) save(); updateStatus();
}

function resetSalasManual() { if(confirm("¬øRESET TOTAL DE TODAS LAS SALAS AHORA?")) { salas.forEach(s => { s.currentGiro = 0; s.count = 0; s.sold = []; s.lastWinner = null; s.isSpinning = false; s.isWaiting = false; s.waitStep = 0; }); save(); alert("Salas Reiniciadas"); location.reload(); } }
function draw() { const canvas = document.getElementById('wheel'), ctx = canvas.getContext('2d'), colors = ['#3366FF', '#FF3333', '#FFCC00', '#009933']; const arc = (Math.PI*2)/200; ctx.clearRect(0,0,600,600); for(let i=0; i<200; i++) { const a = ang + i*arc; ctx.beginPath(); ctx.fillStyle = colors[i%4]; ctx.moveTo(300,300); ctx.arc(300,300,300, a, a+arc); ctx.fill(); ctx.save(); ctx.translate(300,300); ctx.rotate(a+arc/2); ctx.fillStyle="#fff"; ctx.font="bold 8px Arial"; ctx.fillText(wheelNumbers[i], 265, 0); ctx.restore(); } }
function setSala(i) { sSel = i; localStorage.setItem('GCT_S_SEL', i); mySelection = []; document.getElementById('sala-txt').innerText = `SALA #${salas[i]?.id || (i+1)}`; document.getElementById('live-counter').innerText = ""; document.getElementById('status-txt').innerText = ""; renderGrid(); render

